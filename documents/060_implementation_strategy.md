# 実装方針案 (Implementation Strategy)

ユーザーから提起された疑問点に対する回答と、それに基づいた具体的な実装アーキテクチャ案です。

## 1. ユーザーの疑問への回答

### Q1. NocoBaseのプラグインとして実装可能か？
**A. はい、可能です。**
NocoBaseは「プラグインファースト」なアーキテクチャであり、フィールドの挙動（Interface）、設定画面（Schema Settings）、クライアントサイドのロジック拡張が公式にサポートされています。
特に今回は「クライアントサイド（フォームの挙動）」の拡張が主となるため、Client PluginとしてReactコンポーネントを追加・拡張する形で実装します。

### Q2. コレクションとして実装？ / フィールドへの設定として実装？
**A. 「フィールドへの設定（Field Settings）」として実装するのが最適です。**
今回の機能（自動入力、動的絞り込み）は、特定のデータ構造（コレクション）そのものではなく、**「あるフィールドがユーザー入力に対してどう振る舞うか」** という UI/UX の拡張です。
したがって、既存のフィールド（Text, Select等）の設定メニューに「高度な設定」タブを追加し、そこでデータソースやトリガーを設定する形が最も汎用的で NocoBase の流儀に合います。
※ただし、ルール設定自体（例：続柄の絞り込みルール）は、データとして管理するため「コレクション」に保存します。

### Q3. 一つのプラグインとして実装？ / 複数のプラグインとして実装?
**A. 「コア・エンジン」「日本向けプリセット」「日本向けUIインタフェイス」の3層構造に整理します。**

1.  **`plugin-advanced-form-core` (基盤エンジン)**
    *   **責務**: フォームインタラクションの「仕組み」を提供。
    *   **役割**: 住所入力・人名入力のフックエンジン、規準化フレームワーク。
    *   **汎用性**: 日本語に限らず、あらゆる高度なフォーム実装に利用可能。

2.  **`plugin-japan-localization-presets` (日本向け論理・プリセット)**
    *   **責務**: 日本固有の「データ定義」と「ビジネスロジック」を提供。
    *   **役割**: 郵便番号API設定、人名読み変換ルール、続柄等のカタログ。
    *   **軽量性**: UIライブラリへの依存を最小限にし、ロジックと設定データに専念。

3.  **`plugin-japan-localization-interfaces` (日本向けUIインタフェイス)**
    *   **責務**: NocoBaseの「Field Interface」としての高度なUI部品を提供。
    *   **役割**: 
        *   **和暦日付インタフェイス**: 直感的な元号・和暦入力を実現。
        *   **MJ文字セレクター**: 異体字検索・選択用のポップアップUI。
    *   **拡張性**: コアエンジンのフックを利用して、高度なUIインタラクションを実現。

**理由**:
*   **関心の分離**: 「汎用的な仕組み（Core）」「日本向けのデータ・設定（Presets）」「日本向けの高度な見た目（Interfaces）」を分離することで、メンテナンス性と再利用性が最大化されます。
*   **最適化**: ユーザーは「和暦UIだけ使いたい」という場合には Interfaces のみを（Coreと共に）導入し、「背景の自動規準化ロジックだけ使いたい」場合には Presets のみを導入するといった柔軟な選択が可能になります。

### Q4. 4章（補正機能）はNocoBase本体の仕事では？
**A. 基本的なバリデーションは本体機能ですが、今回の「補正（Normalization）」はプラグイン領域です。**
*   **本体の責務**: 「必須チェック」「一意制約」「最大文字数」などのDB整合性に関わる検証。
*   **プラグインの責務**: 「半角→全角変換」「ひらがな化」「ハイフン除去」といった、**UX向上のための入力値変換**。これらは標準機能としては提供されていないため、プラグインでフック（onBlur等）を追加して実装する必要があります。

---

## 2. 具体的な実装アーキテクチャ

### 2-1. コンポーネント設計
*   **Interactive Field Interfaces (Japan Pack)**:
    *   **Date (Wareki Support)**: 標準の Date インタフェイスを継承し、和暦補助フィールド（元号・年・月・日）の表示および西暦との同期ロジックを持つインタフェイス。
*   **Event Hooks (Core)**:
    *   `useKeySequence`: インプットフィールドのキーストロークを監視し、バッファリングされた文字列を後続の変換処理に渡す汎用フック。
*   **Data Source & Normalization Adapters**:
    *   **Core**: 任意の外部APIやコレクション検索を同期するための「アダプター基盤」を提供。
    *   **Pack**: 日本の郵便番号、人名読み候補取得API、MJ文字変換等の具体的な「ビジネスロジック・プリセット」を提供。

### 2-2. 実装ステップ
1.  **Core プラグインの構築**: 自動入力・規準化・キー入力監視の汎用エンジンを実装。
2.  **Japan Localization Pack の構築**: 
    *   **和暦インターフェイス**: 日付フィールドの新しい拡張インタフェイスとして実装。
    *   **ビジネスロジックプリセット**: 住所検索・人名読み等の設定カタログを作成。
    *   **MJ文字セレクター**: 特殊な文字選択UIの実装。
3.  **検証とデモ**: 実際の顧客管理コレクションを用いた総合テスト。
