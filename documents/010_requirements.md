# 要件定義書: 顧客管理UIシステム (改訂版)

## 1. 住所入力支援機能

### 1-1. 概要
日本の住所入力において、郵便番号からの自動補完、およびマスタデータに基づく入力支援機能を提供する。
UIはコンボボックス形式を採用し、マスタに存在しない任意の住所文字列の入力も許容する。

### 1-2. データソースと範囲
膨大な全国住所データの保持を避け、以下の範囲に限定してマスタデータを保持・管理する。

1.  **全国の都道府県・郡・市区町村マスタ**
    *   ソース: e-Stat (市区町村コード)
    *   規模: 約2,000件
2.  **長野県内の大字・町名マスタ**
    *   ソース: e-Stat (町字マスター等)
    *   規模: 長野県分のみ (約3万件未満)

### 1-3. 機能要件
1.  **郵便番号による自動入力**
    *   郵便番号入力完了をトリガーに外部 WebAPI をコール。
    *   取得した [都道府県, 市区町村, 町域] を対応する各フィールドに自動入力する。
    *   入力値正規化: 郵便番号のハイフン有無や全角半角の揺らぎを自動補正すること (A-1)。

2.  **編集可能コンボボックス (Editable Combobox/Datalist)**
    *   マスタにある候補を選択肢として表示する。マスタにない文字列の手動入力も可能とする (データバリデーションエラーにしない)こともできる。

3.  **カスケード (従属) 絞り込み**
    *   上位フィールド (都道府県) の選択状態に応じて、下位フィールド (市区町村) の選択肢を動的にフィルタリングする。
    *   選択肢データは NocoBase 内のマスタテーブルから取得する。

4.  **インクリメンタルサーチの挙動**
    *   マスタデータには「読み仮名 (ひらがな)」カラムを持たせる。
    *   **フロントエンド検索**: ユーザーが数文字入力した時点で DB 検索を行い、候補を取得。以降の絞り込みはフロントエンド (メモリ上) で行うことでパフォーマンスを確保する (A-4)。

---

## 2. 動的リレーションシップ (続柄) 制御機能

### 2-1. 概要
性別や他のフィールド値の組み合わせに基づき、「続柄」フィールドの選択肢を動的に制御する。
複雑な条件分岐はコードへのハードコーディングを避け、ルール定義テーブルによって管理する。

### 2-2. 機能要件
1.  **性別による選択肢フィルタ**
    *   対象者の「性別」に応じて、「続柄」の選択肢を絞り込む。
    *   例: 性別=男 → 候補: 父, 夫, 長男...

2.  **複合条件による絞り込み**
    *   `[基準となる続柄]` (例: 一人目の続柄) と `[対象者の性別]` (例: 二人目の性別) の組み合わせにより、`[結果の続柄]` (例: 二人目の続柄) の候補を決定する。
    *   **基準点の設定**: UI設定画面において、フィルタの基準となるフィールド (Source Field) を指定可能にする (B-1)。

3.  **ルール定義の外部化 (B-2)**
    *   絞り込みロジックは専用のマスタテーブル (`RelationshipRules` 等) に定義する。
    *   テーブル構造イメージ:
        *   `source_relation` (基準続柄: 父, nullなら無条件/本人など)
        *   `target_gender` (対象性別: 男/女/その他)
        *   `candidate_relation` (候補となる続柄: 長女)
    *   整合性チェック (B-3) は不要とする。システム側での厳密な排他制御は行わない。

---

## 3. 人名読み方入力補助機能

### 3-1. 概要
姓・名の入力フィールドに入力時に、それらの読み仮名のフィールドに入力候補を表示する機能を提供する。また、入力候補を取得するためのWebAPIを提供する。

### 3-2. 機能要件
1.  **入力候補の取得**
    *   入力候補は以下から取得する。（複数のソースを組み合わせを可能とする）
        *   姓・名の入力フィールドに入力時に、キー入力
        *   WebAPI
        *   顧客DBの既存データ検索

## 4. 人名の正式な表記の入力補助

### 4-1. 概要
戸籍上の正式な姓名が入力・保存・検索できるようにする。

1.  **姓名の種類**
    *   DB上の人名としては、・IMEで入力できる一般的な「姓名」、・異字・俗字・くずし字を含む正式な「姓名（正式）」、・もっとも一般的な漢字・かなのみの「氏名（検索用）」、の３つを考慮する。
    *   姓名は、姓と名が別カラムであることも、一つの氏名カラムであることもありうる。UI上の入力フィールドも同様である。
    *   「姓名（正式）」にはUNICODE IVS の Hanyo-denshi (汎用電子情報交換用文字) の文字が含まれる。
    *   「姓名（正式）」の入力フィールド及び表示には、IPAmj フォント（明朝あるいはゴシック）を用いる。
    *   「氏名（検索用）」への変換ルール：史料編纂所データベース異体字同定一覧（https://wwwap.hi.u-tokyo.ac.jp/ships/itaiji_list.jsp）に基づき、右列の各文字（異体字等）を左列の文字（標準的な漢字）に変換する。また、IVD（IVS）の枝番コードは削除する。

2.  **異字・俗字・くずし字の入力補助**
    *   姓名（正式）フィールドにおいて、異字・俗字・くずし字の入力補助を提供する。
    *   このフィールドでは、まずIMEによって通常と同様に文字列を入力、あるいは姓名フィールドより文字列がコピーされる。
    *   次に、ユーザーが一文字を選択すると、その文字の異字・俗字・くずし字の候補のリストが表示される。
    *   ユーザーが候補のリストから一文字を選択すると、その文字が姓名（正式）フィールドに反映される。
    *   候補リストの作成ロジックは、MJ文字情報一覧表（ https://moji.or.jp/mojikiban/mjlist/ ）および史料編纂所データベース異体字同定一覧（ https://wwwap.hi.u-tokyo.ac.jp/ships/itaiji_list.jsp ）の対応関係を参照する。

3.  **氏名（検索用）への変換機能**
    *   DBあるいは入力フィールド上の、姓名・姓名（正式）の文字列を、氏名（検索用）に変換する。

---

## 5. 和暦入力補助機能

### 5-1. 概要
日付フィールド（主に生年月日）において、和暦（元号、年、月、日）による入力を補助し、西暦（A.D.）との相互変換を行う機能を提供する。

### 5-2. 機能要件
1.  **元号・和暦・日付の相互変換**
    *   元号（明治、大正、昭和、平成、令和）、和暦年、月、日が入力された際、即座に対応する西暦の日付を計算し、日付フィールド（西暦）に反映する。
    *   月日が未入力の場合は、デフォルトとして1月1日を補完して計算する。
    *   西暦の日付フィールドが直接編集された場合、対応する和暦（元号、年、月、日）を逆算し、補助フィールドに反映する。

2.  **UI上の配置**
    *   日付フィールドに付随する入力補助要素として、元号選択（ドロップダウン）、年（数値入力）、月（数値入力）、日（数値入力）の各フィールドを配置可能とする。
    *   これらの補助フィールドの値はデータベース（コレクション）には保存せず、フロントエンドでの計算および入力支援のみに利用する。


