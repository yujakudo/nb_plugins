# 機能要件定義書 (Functional Specification)

ユーザーから提示された要件に基づき、開発するプラグインに必要な機能を整理・定義する。
汎用性を重視し、特定の業務要件（郵便番号など）に固定しない設計とする。

## 1. 他フィールドへの値の自動入力機能 (Auto-fill)

### 1-1. トリガーと動作
*   **トリガー**: 特定のフィールド（**トリガーフィールド**）の値が変更された時、または入力が完了（Blur）した時。
    *   *設定*: `onChange` (デバウンス付き) か `onBlur` かを選択可能にする。
*   **動作**: 外部データソース（下記参照）からデータを取得し、**ターゲットフィールド**（複数可）に値を設定する。

### 1-2. データソース
*   **フィールド**: 各フィールドの値をデータソースとして参照できる。
*   **NocoBaseリソース (Collection)**: NocoBase内の他のコレクション（テーブル）を検索する。
    *   *注記*: 内部的にはNocoBase APIを使用するが、設定の利便性（コレクションピッカー等）のため、外部APIとは区別する。
*   **外部 WebAPI**: `api_proxy` 等を通じて管理される外部API接続。
*   **計算式**: 上記データソースの値を組み合わせて、検索条件（フィルタパラメータ）として使用できる。また各データソースは、コレクションの検索キーやAPIのパラメータとしても使用可能。

### 1-3. マッピング設定
*   取得したデータ（データソースから返却されたレコード）のどのプロパティを、フォームのどのフィールドにセットするかを定義する機能。
    *   セット先のフィールドは、複数を可能にする。
    *   例: `dataSource.address1` → `field_prefecture`

### 1-4. 上書き制御
*   ターゲットフィールドに既に値が入っている場合の挙動設定。
    *   常に上書き / 空の場合のみ書き込み

### 1-5. 規準化 (Normalization) との連携
*   自動入力が完了した直後、対象のターゲットフィールドに対して定義されている「規準化 (Normalization)」処理を自動的に実行する。

---

## 2. 動的な選択肢制御機能 (Dynamic Options / Combobox)

### 2-1. コンポーネント挙動
*   **コンボボックス**: 選択肢からの選択と、自由入力を両立するUI。
    *   *設定*: 「選択肢のみ許可（Select相当）」か「自由入力許可（Combobox相当）」か切り替え可能にする。
*   **選択肢候補の取得タイミング**: 選択肢候補の取得タイミングは設定可能とする。
    *   フィールドにフォーカスが当たった時点。
    *   フィールドの内容が変わった時点（on change）。
    *   ユーザーが入力フィールドに指定の文字数キー入力をした時点。
*   **ローディング表示**: データ取得中にUI上でローディングインジケータを表示する（UX要件）。

### 2-2. 選択肢データソース
*   1-2と同様。複数ソースを組み合わせて選択肢候補にできる。
*   データソースには、読み方のような、ソートキーや候補の動的絞り込みに利用できる属性を含むことができる。

*   **選択肢のソーティング**: 選択肢候補をソートする。
    *   *設定*: "昇順"/"降順"/"なし"を選択可能にする。
    *   *ソートキー*: 選択肢候補のどの属性でソートするかを選択可能にする。


### 2-3. 候補の動的絞り込み
*   ユーザーが入力フィールドにキーを入力するたびに、表示する候補を動的に絞り込む。
*   入力フィールドへのキー入力をトレースし、英数であればひらがなに変換し、文字列を保持する。
*   **ステージ1 (Backend)**: ユーザー入力が指定文字数（例: 2文字）に達した時点で、サーバーサイド（API/DB）へ検索リクエストを投げる。
*   **ステージ2 (Frontend)**: 取得した候補リスト（例えば最大100件）に対し、以降の追加入力についてはフロントエンド上でフィルタリングを行う。

*   **ステージ3 (Frontend)**: フィルタリングした候補の数が、ユーザーにとって選択可能となったとき（例: 20件未満）に初めて候補リストを表示する。

### 2-4. キャッシュ戦略 (追加提案)
*   外部 WebAPIやNocoBaseリソース検索の負荷を軽減するため、同一条件での結果を一時的にキャッシュするオプションを設ける（特にマスタデータなど頻繁に変わらないもの）。


---

## 3. 入力値の規準化・バリデーション機能 (Normalization & Validation)

### 3-1. 規準化 (Normalization)
*   **タイミング**: `onBlur` (フォーカスが外れた時)。
*   **処理内容**:
    *   全角/半角変換 (英数字、記号)。
    *   文字種統一 (ひらがな化/カタカナ化)。
    *   フォーマット整形 (ハイフン除去/付与)。
    *   標準字変換 (異体字・IVSコードの除去、標準漢字への置換)。

### 3-2. 検証 (Validation)
*   正規表現によるフォーマットチェック。
*   エラー時にはフォーム送信をブロック、または警告を表示。

---

## 4. 人名読み方入力補助機能 (Name Reading Assistance)

### 4-1. 読み仮名の自動生成・候補表示
*   **キー入力トレース**: 姓名フィールドへの入力時、キーボード入力をフックして読み仮名（ひらがな）を推測・保持する。
*   姓名フィールドへの入力途中に候補リストが選択された場合は、候補リストの読み仮名が、キーボード入力フックに上書きされる。
*   **候補の統合**: 以下のソースから得られた候補を統合して表示する。
    *   キー入力履歴からの推測。
    *   外部WebAPIへのリクエスト（入力中の漢字に対する読みの取得）。
    *   既存顧客コレクションの検索（同姓・同名のデータの読みを参照）。

### 4-2. 入力反映
*   ユーザーが候補を選択した際、指定された「読み仮名用フィールド」へ値を自動入力する。

---

## 5. 人名の正式表記・異体字対応機能 (Official Name Support)

### 5-1. 文字表示・入力基盤
*   **IPAmjフォント対応**: 正式姓名フィールドおよび表示コンポーネントにおいて、IPAmj明朝フォントを適用可能とする。
*   **Unicode IVS (Hanyo-denshi) 対応**: IVSコードを含む文字列の保持・表示をサポートする。

### 5-2. 異体字セレクター (Character Selector)
*   **動作**: 姓名（正式）フィールド内の任意の1文字をユーザーが選択（カーソル合わせ/ハイライト）した際、その文字に対応する異体字・俗字・くずし字の候補リストをポップアップ表示する。
*   **データ参照**: MJ文字情報一覧および史料編纂所データベースの対応データに基づき、候補を生成する。
*   **反映**: 選択された異体字で元の文字を置換し、IVSコードを付与して保存する。

### 5-3. 氏名（検索用）への自動規準化
*   **タイミング**: 保存時または姓名フィールドの更新時。
*   **ロジック**:
    1.  IVS/IVDコード（枝番）の除去。
    2.  異体字から標準漢字への置換。
        *   参照ソース: 史料編纂所データベース異体字同定一覧に基づき、異体字を標準的な漢字（左列）に置換する。
*   **出力**: 変換後の文字列を「氏名（検索用）」フィールドに格納する。

---

## 6. 和暦入力補助機能 (Japanese Calendar Input)

### 6-1. 概要
日付フィールドに対して、元号・和暦等による入力を可能にする補助フィールド群を提供する。

### 6-2. 補助フィールドの構成
*   **元号選択**: 明治、大正、昭和、平成、令和をプルダウンまたはセレクターで選択。
*   **年、月、日**: 数値入力。
*   これらは一つの「和暦入力コンポーネント」として日付フィールド（西暦）にプラグイン形式で追加される。

### 6-3. 相互変換ロジック
*   **和暦 → 西暦**: 
    *   元号と和暦年、月、日から西暦を計算する。
    *   月・日が空の場合は、それぞれ「1」として計算する。
*   **西暦 → 和暦**:
    *   西暦日付が入力・変更された場合、対応する元号・和暦年・月・日を算出し、補助フィールドに即座に反映する。

---

## 7. UI/UX 要件 (共通)
*   **キーボード操作**: マウスを使わず、Tabキーでの移動、矢印キーでの候補選択、Enterキーでの確定ができること。
*   **アクセシビリティ**: スクリーンリーダー等への配慮（ARIA属性）。
