# ユースケースの実現について

## 目的
本文書は、定義された「ユースケース」が、「UIデザイン」で示された設定機能を用いてどのように実現されるかを記述し、実現可能性を検証することを目的とする。

## 1. 氏名の入力

### 1-1. 姓と名の入力

#### 1-1-1. 姓の入力
*   **概要**: 姓フィールドへの入力（キー操作）に基づき、候補リスト（漢字）を表示・選択させる。選択後、正式名称・検索用名称・かな名称を自動入力する。
*   **設定 (UIデザインの適用)**:
    *   **対象フィールド**: 「姓」
    *   **候補リスト表示機能 (C)**:
        *   有効化: ON
        *   初期表示タイミング: `2文字入力後`
        *   入力ごとの絞り込み: `ON`
        *   ソート: `昇順`
        *   データソース:
            *   データソース名: `customer_surname`
                *   参照式: `{{surname}}`
                *   絞り込み項目名: `surname_kana`
                *   ソートキー: `surname_kana`
                *   検索条件: `{"surname_kana": {"$like": "{{current_input}}%"}}`
                    *   ※仕様未定
                *   データソース: `コレクション検索`
                *   コレクション/API名: `surname_view`
                    *   SQLコレクションとして作成（ SELECT DISTINCT surname, surname_kana FROM customer）

    *   **自動入力連携機能 (B)**:
        *   キーシーケンスの保持: ON
            *   ※姓（かな）のフィールドの値・候補として利用するため
        *   有効化: ON
        *   フィールドマッピング:
            *   フィールド名：`surname_official` (姓（正式）)
                *   データソース：（なし）
                *   参照式：`{{surname}}`
                *   上書き： しない
            *   フィールド名：`search_name` (氏名（検索用）)
                *   データソース：（なし）
                *   参照式：`generalizeJapaneseName("{{form.surname}} + {{form.given_name}}")`
                    *   ※氏名検索用文字列への変換機能を利用できるようにすること
                *   上書き： する
            *   フィールド名：`surname_kana`
                *   データソース：（なし）
                *   参照式：`{{key_sequence}}`
                    *   ※キーシーケンスの参照文字列を「key_sequence」とするかは仕様未定
                *   上書き： しない


#### 1-1-2. 名の入力
*   **概要**: 名フィールドへの入力に基づき候補リストを表示・選択。選択後、各フィールドへ自動入力・追記を行う。
*   **設定 (UIデザインの適用)**:
    *   **対象フィールド**: 「名」
    *   **候補リスト表示機能 (C)**:
        *   有効化: ON
        *   初期表示タイミング: `2文字入力後`
        *   入力ごとの絞り込み: `ON`
        *   ソート: `昇順`
        *   データソース:
            *   データソース名: `customer_given_name`
                *   参照式: `{{form.given_name}}`
                *   絞り込み項目名: `given_name_kana`
                *   ソートキー: `given_name_kana`
                *   検索条件: `{"given_name_kana": {"$like": "{{current_input}}%"}}`
                *   データソース: `コレクション検索`
                *   コレクション/API名: `given_name_view`
                    *   SQLコレクションとして作成（ SELECT DISTINCT given_name, given_name_kana FROM customer）

    *   **自動入力連携機能 (B)**:
        *   キーシーケンスの保持: ON
        *   有効化: ON
        *   フィールドマッピング:
            *   フィールド名：`given_name` (名（正式）)
                *   データソース：（なし）
                *   参照式：`{{form.given_name}}`
                *   上書き： しない
            *   フィールド名：`search_name` (氏名（検索用）)
                *   データソース：（なし）
                *   参照式：`generalizeJapaneseName("{{form.surname}} + {{form.given_name}}")`
                    *   ※氏名検索用文字列への変換機能を利用できるようにすること
                *   上書き： する
            *   フィールド名：`given_name_kana`
                *   データソース：（なし）
                *   参照式：`{{key_sequence}}`
                *   上書き： しない

### 1-2. よみがなの入力
*   **概要**: かなフィールドへのフォーカスでAPI経由の候補を表示。入力確定後のカタカナ→ひらがな変換。
*   **設定 (UIデザインの適用)**:
    *   **対象フィールド**: 「姓（かな）」および「名（かな）」
    *   **候補リスト表示機能 (C)**:
        *   有効化: ON
        *   初期表示タイミング: `フォーカス時`
        *   入力ごとの絞り込み: `ON`
        *   ソート: `昇順`
        *   データソース:
            *   データソース名: `姓の入力`
                *   参照式: `{{surname.key_sequence}}`
                *   絞り込み項目名: `surname.key_sequence`
                *   ソートキー: `surname.key_sequence`
                *   データソース: `フォーム`
            *   データソース名: `reading_api`
                *   参照式: `{{yomi}}`
                *   絞り込み項目名: `yomi`
                *   ソートキー: `yomi`
                *   データソース: `外部API`
                *   コレクション/API名: `reading_api`

    *   **自動規準化機能 (A)**:
        *   ルール:
            *   ルール名: `カタカナ統一`
                *   正規表現: `[\u30a1-\u30f6]`
                *   置換文字: (ひらがなへ変換するロジック)
                    *   ※UIデザインの「プリセットロジック」に `カタカナに統一` (またはひらがな) を追加推奨

### 1-3. 正式な姓と名の入力
*   **概要**: 具体的な文字（「辺」など）を選択し、異体字（IVS）候補リストから選択・置換する。
*   **設定 (UIデザインの適用)**:
    *   **対象フィールド**: 「姓（正式）」、「名（正式）」
    *   **MJ文字・正式表記セレクター (2-2)**:
        *   設定: 特になし（コンポーネントとして適用するだけで機能する想定）

### 1-4. 氏名（検索用）を利用した検索
*   **概要**: 正規化された「氏名（検索用）」フィールドを用いて検索を行う。
*   **設定 (UIデザインの適用)**:
    *   特定のUI設定ではなく、データモデル設計と検索時の対象フィールド指定（NocoBase標準機能）にて実現。
    *   「氏名（検索用）」への値セットは、1-1の自動入力連携にて担保される。

## 2. 性別の入力
*   **概要**: フォーカスによりドロップダウンリストから選択。
*   **設定 (UIデザインの適用)**:
    *   **対象フィールド**: 「性別」
    *   NocoBase標準の「Select」インターフェイス、または **候補リスト表示機能 (C)** の「フォーカス時」表示を利用。固定値リストであれば標準機能で十分。

## 3. 続柄の入力
*   **概要**: 顧客0（世帯主等）の続柄と本人の性別から、動的に候補リストを生成・表示。
*   **設定 (UIデザインの適用)**:
    *   **対象フィールド**: 「続柄」
    *   **候補リスト表示機能 (C)**:
        *   有効化: ON
        *   初期表示タイミング: `フォーカス時`
        *   入力ごとの絞り込み: `OFF`
        *   ソート: `しない`
        *   データソース:
            *   データソース名: `relationship_list`
                *   参照式: `{{relationship}}`
                *   絞り込み項目名: (なし)
                *   ソートキー: （なし）
                *   データソース: `外部API`
                *   コレクション/API名: `relationship_api`
                *   検索条件: `{"gender": "{{form.gender}}", "base_relationship": "{{form.customer0_relationship}}"}`
                    *   `customer0_relationship`はフォーム上にHiddenフィールドとして設定。

## 4. 住所の入力

### 4-1. 郵便番号と住所の入力
*   **概要**: 郵便番号入力後、フォーマット修正を行い、住所APIを呼び出して都道府県～町名まで自動入力。
*   **設定 (UIデザインの適用)**:
    *   **対象フィールド**: 「郵便番号」
    *   **自動規準化機能 (A)**:
        *   有効化: ON
        *   よく使うルール: `英数字を半角に統一`
        *   ルール:
            *   ルール名: `zip_hyphen`
                *   正規表現: `^(\d{3})(\d{4})$`
                *   置換文字: `$1-$2`

    *   **自動入力連携機能 (B)**:
        *   キーシーケンㇲの保持: OFF
        *   有効化: ON
        *   データソース:
            *   データソース名: `address_api`
                *   検索条件: `{zip: {{zipcode}} }`
                *   データソース: `外部API`
                *   コレクション/API名: `address_search_api`
        *   フィールドマッピング:
            *   フィールド名：`prefecture` (都道府県)
                *   参照式：`{{address_api.prefecture}}`
                *   上書き： する
            *   フィールド名：`area` (郡)
                *   参照式：`{{address_api.area}}`
                *   上書き： する
            *   フィールド名：`city` (市区町村)
                *   参照式：`{{address_api.city}}`
                *   上書き： する
            *   フィールド名：`town` (大字・町名)
                *   参照式：`{{address_api.town}}`
                *   上書き： する

### 4-2. 郵便番号を入力しない場合の住所の入力
*   **概要**: 都道府県、市区町村、町名の各フィールドにて、入力読み（キーシーケンス）による絞り込み候補選択。
*   **設定 (UIデザインの適用)**:
    *   **対象フィールド**: 「都道府県」
    *   **候補リスト表示機能 (C)**:
        *   有効化: ON
        *   初期表示タイミング: `1文字入力後`
        *   入力ごとの絞り込み: `ON`
        *   データソース:
            *   データソース名: `prefecture_master`
                *   参照式: `{{name}}`
                *   絞り込み項目名: `kana`
                *   ソートキー: （なし）
                *   データソース: `コレクション検索`
                *   コレクション/API名: `都道府県マスタ`
                *   検索条件: `{"kana": {"$like": "{{current_input}}%"}}`
        *   ソート: `しない`

    *   **対象フィールド**: 「市区町村」
    *   **候補リスト表示機能 (C)**:
        *   有効化: ON
        *   初期表示タイミング: `1文字入力後`
        *   入力ごとの絞り込み: `ON`
        *   データソース:
            *   データソース名: `city_master`
                *   参照式: `{{city}}`
                *   絞り込み項目名: `kana`
                *   ソートキー: （なし）
                *   データソース: `コレクション検索`
                *   コレクション/API名: `市区町村マスタ`
                *   検索条件: `{"prefecture": "{{prefecture}}", "kana": {"$like": "{{current_input}}%"}}`
        *   ソート: `しない`

    *   **対象フィールド**: 「大字・町名」
    *   **候補リスト表示機能 (C)**:
        *   有効化: ON
        *   初期表示タイミング: `1文字入力後`
        *   入力ごとの絞り込み: `ON`
        *   データソース:
            *   データソース名: `town_master`
                *   参照式: `{{town}}`
                *   絞り込み項目名: `kana`
                *   ソートキー: （なし）
                *   データソース: `コレクション検索`
                *   コレクション/API名: `大字・町名マスタ`
                *   検索条件: `{"prefecture": "{{prefecture}}", "city": "{{city}}", "kana": {"$like": "{{current_input}}%"}}`
        *   ソート: `しない`

### 4-3. 番地以降の入力
*   **概要**: 全角数字などを半角等の規定フォーマットに自動修正。
*   **設定 (UIデザインの適用)**:
    *   **対象フィールド**: 「番地」、「建物等」
    *   **自動規準化機能 (A)**:
        *   ルール: `英数字を半角に統一`
        *   ルール: `ハイフン統一` (各種ダッシュ、マイナス等をASCIIハイフンへ)

### 4-4. 地区の入力
*   **概要**: 読み入力による候補リスト選択。
*   **設定 (UIデザインの適用)**:
    *   **対象フィールド**: 「地区」
    *   **候補リスト表示機能 (C)**:
        *   有効化: ON
        *   初期表示タイミング: `フォーカス時`
        *   入力ごとの絞り込み: `ON`
        *   データソース:
            *   データソース名: `district_master`
                *   参照式: `{{district}}`
                *   絞り込み項目名: `kana`
                *   データソース: `コレクション検索`
                *   コレクション/API名: `地区マスタ`
                *   検索条件: `{"prefecture": "{{prefecture}}", "city": "{{city}}", "town": "{{town}}", "kana": {"$like": "{{current_input}}%"}}`

## 5. 電話番号、携帯電話番号、FAX、メールアドレスの入力

### 5-1 ～ 5-3. 各連絡先の入力
*   **概要**: 入力完了時に全角半角変換、不要文字削除、フォーマット（ハイフン挿入等）を行う。
*   **設定 (UIデザインの適用)**:
    *   **対象フィールド**: 「電話番号」、「携帯電話番号」、「FAX」、「メールアドレス」
    *   **自動規準化機能 (A)**:
        *   よく使うルール: `英数字を半角に統一`, `電話番号ハイフン統一`

### 5-4. メールアドレスの入力
*   **概要**: 入力完了時に全角半角変換、不要文字削除、フォーマット（ハイフン挿入等）を行う。
*   **設定 (UIデザインの適用)**:
    *   **対象フィールド**: 「メールアドレス」
    *   **自動規準化機能 (A)**:
        *   よく使うルール: `英数字を半角に統一`

## 6. 生年月日の入力

### 6-1. 生年月日の入力・修正
*   **概要**: 和暦フィールド（年号・年・月・日）と西暦日付フィールドの双方向同期。
*   **設定 (UIデザインの適用)**:
    *   **対象フィールド**: 「生年月日」（このフィールドを代替するカスタムUIとして配置）
    *   **和暦日付インタフェイス (2-1)**:
        *   このコンポーネントを配置することで実現。
        *   UI仕様書にある通り「二つの入力群は双方向に同期される」ため、追加設定なしで挙動を満たす。
