# plugin_api_proxy 改造計画レポート

本ドキュメントでは、`plugin_api_proxy` に対する以下の2つの機能追加の実装方法について検討し、報告します。

1. **マッピング機能**: クライアントのリクエスト・レスポンス形式を NocoBase API 形式に合わせる（Get/Listのみ）
2. **プリセット差込機能**: 他のプラグインから設定プリセットを登録可能にする（プログラム処理含む）

## 1. マッピング機能

### 1.1 概要
外部APIの独自のリクエストパラメータやレスポンス構造を、NocoBase標準のAPI形式（`list`, `get` アクション）に適合させるための変換レイヤーを実装します。

### 1.2 設定データ構造
`api_proxy_apis` コレクションの設定項目として以下を定義します。

**概要**
*   **マッピングの有効化**: Checkbox (ON/OFF)

**リクエスト設定**
*   **マッピング**: Text
    *   例: `{ zipcode: "{{zip}}" }`
    *   `{{zip}}` は、リクエストパラメータの `filter.zip` あるいは `filter.zip.$eq` の値に置換されます。

**レスポンス設定**
*   **レスポンスの種類**: Select （JSON、テキスト、CSV。デフォルト: JSON）
*   **リスト**: Checkbox （レスポンスが単一のデータか、リストか）

#### JSONのときの設定項目
*   **リスト要素**（リストのときのみ）: Text
    *   例: `data.cities` (レスポンスが `{ data: { cities: [{...}, ... ] }}` のようなとき)
    *   例: （空白） (レスポンスが `[{...}, ... ]` のように、いきなり配列のとき)
*   **マッピング**: Text
    *   例: `{ name: "{{data.city}}"}`
        *   単一データで、レスポンスが `{ data: { city: "諏訪市" }}` のようなとき
    *   例: `{ name: "{{name}}"}`
        *   リストデータで、レスポンスが `{ data: { cities: [{ name: "諏訪市" }, ... ] }}` のようなとき、繰り返し項目からのパス。
    *   例: `{ name: "{{}}"}`
        *   リストデータで、レスポンスが `["諏訪市", ... ]` のように、繰り返し項目直下がデータのとき。

#### テキストのときの設定項目
*   **マッピング**: Text
    *   例: `{ name: "{{data}}"}`
        *   キーワード `data` は仮。`{{data}}` がレスポンスのテキスト全体に置き換えられます。

#### CSVのときの設定項目
*   **一列目が列名**: Checkbox
    *   Trueのときは一列目をデータでなく列タイトルとして扱います。
*   **マッピング**: Text
    *   例: `{ prefecture_no: "{{1}}", prefecture_name: "{{2}}", ...}`
        *   `{{1}}`, `{{2}}` はそれぞれ、1列目の値、2列目の値に置き換えられます。
    *   例: `{ prefecture_no: "{{番号}}", prefecture_name: "{{県名}}", ...}`
        *   「一列目が列名」の場合、列名でも参照できるようにします。

### 1.3 レスポンスデータの処理の流れ

1.  **データ取得**: マッピングの設定に従って、外部API等からデータを取得 (response_data)。
2.  **配列への統一**: APIからのレスポンスを配列形式に統一します。
    *   APIのレスポンスが単一データのときは、マッピング結果を配列に入れ、要素数1の配列にします。
        *   例: `response_data = [{name: "諏訪市"}]`
    *   APIのレスポンスがリストのときは、マッピング結果はそのまま配列として扱います。
        *   例: `response_data = [{name: "諏訪市"}, ...]`
3.  **フィルタリング**: クライアントからのリクエスト時の `filter` に演算子が含まれる場合、それを処理し、不必要な配列要素を削除します。
    *   参照: [NocoBase Operators](https://docs-jp.nocobase.com/api/database/operators)
    *   すべての演算子を実装する必要はありませんが、LIKE系 (`$includes` 等) は実装します。
4.  **レスポンス整形**: クライアントからのリクエストのアクションによって最終的なレスポンス形式を整形します。
    *   アクションが `get` のときは、配列の先頭要素だけを返します。
        *   例: `response = { data: response_data[0] }`
    *   アクションが `list` のときは、配列全体を返します。
        *   例: `response = { data: response_data }`

* マッピングが必要なときのクライアントからのリクエストについて、ページ処理は考えないもとのする。

## 2. プリセット差込機能

### 2.1 概要
他のプラグインが `plugin_api_proxy` に対して「API設定の雛形（プリセット）」を登録できる仕組みを作ります。
特に、外部APIを呼ばずにプログラム内部でデータを生成・返却する場合も考慮します。

### 2.2 処理フックとユースケース
差し込みデータにフックを定義して、`plugin_api_proxy` の標準処理の代わりに、プリセット側の処理を呼び出せるようにします。

**主なユースケース:**
*   **パフォーマンス向上**: 当初は外部APIで都道府県リストを取得していたが、レスポンス高速化のためNocoBaseサーバ上のメモリ内処理に切り替える。
*   **ロジック実装**: 「続柄検索」など、外部APIではなくプログラムロジックでレスポンスを生成する。

**フックポイント:**
1.  **リクエスト時のマッピング**: リクエストパラメータの変換処理。
2.  **APIコールの代わりの処理 (Exection Hook)**: 実際にデータを取得・生成する処理。外部APIコールの代わりに実行されます。
3.  **レスポンスのマッピング**: 取得したデータの変換処理。
    *   例: レスポンスのマッピングだけをプログラムで処理したい場合など。

### 2.3 登録インターフェース案
```typescript
interface ApiPreset {
  key: string;
  label: string;
  // 外部API設定のデフォルト値
  url?: string;
  headers?: any;
  // プログラム処理用フック (Optional)
  onRequest?: (context: Context) => Promise<any>; // マッピング前/後の制御
  execute?: (requestData: any) => Promise<any>;   // APIコールの代わりの処理
  onResponse?: (responseData: any) => Promise<any>; // レスポンスマッピング処理
}

## 4. APIテスト機能

### 4.1 概要
設定画面上で、定義したマッピングルールが意図通りに機能するかを確認するためのテスト実行機能を提供します。

### 4.2 機能要件
- **目的**: 
    *   外部APIの仕様を確認するためのテスト実行機能を提供する。
    *   API設定のマッピング設定を確認するためのテスト実行機能を提供する。
    *   複雑なJSONパス指定やリスト設定のデバッグを容易にする。

- **パラメータ入力**: URLパスパラメータやクエリパラメータ（フィルタ等）のテスト値を入力可能にする。
    - **ヘッダ**: クライアントからのリクエストヘッダ
    - **データ**: クライアントからのリクエストデータ
    - **保存ボタン**: テスト値を保存する。不具合が起こったときに、すぐに確認ができるようにするため。
    - **実行ボタン**: テスト値を用いて実際に、リクエスのマッピング処理、外部APIへのリクエストの送信（またはプリセットの `execute` フックの呼び出し）、レスポンスのマッピング処理を行う。

- **結果表示**:
    - **APIリクエストデータ**: 外部APIリクエスト時のデータ（マッピング終了後のリクエストデータ）
    - **APIレスポンスデータ**: 外部APIからのレスポンスデータ。
    - **レスポンスデータ**: マッピング設定適用後のNocoBase形式データ。
    - **ステータス**: HTTPステータスコードやエラーメッセージ。

```

## 3. 今後の進め方
1.  **PresetManagerの実装**: フック機能を含むプリセット管理クラスの実装。
2.  **データ構造の実装**: `api_proxy_apis` コレクションへのフィールド追加。
3.  **Processorの実装**: 上記「1.3 レスポンスデータの処理の流れ」を実装するプロセッサロジックの作成。
4.  **UI実装**: 設定画面への反映（別タスクにてUI設計詳細化）。

以上
