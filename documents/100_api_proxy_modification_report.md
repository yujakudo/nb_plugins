# plugin_api_proxy 改造計画レポート

本ドキュメントでは、`plugin_api_proxy` に対する以下の2つの機能追加の実装方法について検討し、報告します。

1. **マッピング機能**: クライアントのリクエスト・レスポンス形式を NocoBase API 形式に合わせる（Get/Listのみ）
2. **プリセット差込機能**: 他のプラグインから設定プリセットを登録可能にする（プログラム処理含む）
1.  **マッピング機能**: クライアントのリクエスト・レスポンス形式を NocoBase API 形式に合わせる（Get/Listのみ）
2.  **プリセット差込機能**: 他のプラグインから設定プリセットを登録可能にする（プログラム処理含む）

## 1. マッピング機能

### 1.1 概要
外部APIの独自のリクエストパラメータやレスポンス構造を、NocoBase標準のAPI形式（`list`, `get` アクション）に適合させるための変換レイヤーを実装します。

### 1.2 設定データ構造 (UI定義)
`api_proxy_apis` コレクションの設定項目として以下を定義し、それぞれツールチップによる説明を提供します。

**基本設定**
*   **名前** (`name`): 入力。必須。
*   **説明** (`description`): Markdown。
*   **メソッド** (`method`): 選択 (GET/POST)。
*   **URL** (`url`): 入力 (URL形式)。必須。
*   **ヘッダ** (`headers`): JSON。
*   **プリセット** (`preset`): 選択。他のプラグインからの登録用。

**マッピング設定**
*   **マッピングの有効化** (`mappingEnabled`): Checkbox。
    *   ラベル: 「マッピングを有効にする」
*   **リクエストマッピング** (`requestMapping`): JSON/Text。
*   **レスポンスの種類** (`mappingMode`): 選択 (JSON, CSV, テキスト)。
*   **リスト** (`isList`): Checkbox。
    *   ラベル: 「APIのレスポンスは配列」
    *   `mappingMode` が JSON かつ `mappingEnabled` が ON のときのみ表示。
*   **リスト要素** (`listPath`): 入力。
    *   `isList` が ON のときのみ表示。
*   **一列目が列名** (`csvHasHeader`): Checkbox。
    *   ラベル: 「一列目が列名のラベルであることを示す」
    *   `mappingMode` が CSV のときのみ表示。
*   **レスポンスマッピング** (`responseMapping`): JSON。
    *   `mappingMode` に応じて動的にツールチップの説明を切り替えます。

**テスト設定**
*   **テストパラメータ** (`testParams`): 複数行テキスト。
*   **期待されるレスポンス** (`expectedResponse`): 複数行テキスト。

**利用制限設定**
*   **利用制限** (`limit`): 選択 (なし, 日, 週, 月, 年)。
*   **最大利用回数** (`maxRequests`): 数値。
*   **開始月/日/曜日/時刻**: 制限単位に応じた入力。
*   **タイムゾーン**: 選択。

### 1.3 レスポンスデータの処理の流れ

1.  **データ取得**: マッピングの設定に従って、外部API等からデータを取得 (response_data)。
2.  **配列への統一**: APIからのレスポンスを配列形式に統一します。
    *   APIのレスポンスが単一データのときは、マッピング結果を配列に入れ、要素数1の配列にします。
        *   例: `response_data = [{name: "諏訪市"}]`
    *   APIのレスポンスがリストのときは、マッピング結果はそのまま配列として扱います。
        *   例: `response_data = [{name: "諏訪市"}, ...]`
3.  **フィルタリング**: クライアントからのリクエスト時の `filter` に演算子が含まれる場合、それを処理し、不必要な配列要素を削除します。
    *   参照: [NocoBase Operators](https://docs-jp.nocobase.com/api/database/operators)
    *   すべての演算子を実装する必要はありませんが、LIKE系 (`$includes` 等) は実装します。
4.  **レスポンス整形**: クライアントからのリクエストのアクションによって最終的なレスポンス形式を整形します。
    *   アクションが `get` のときは、配列の先頭要素だけを返します。
        *   例: `response = { data: response_data[0] }`
    *   アクションが `list` のときは、配列全体を返します。
        *   例: `response = { data: response_data }`

* マッピングが必要なときのクライアントからのリクエストについて、ページ処理は考えないもとのする。

## 2. プリセット差込機能

### 2.1 概要
他のプラグインが `plugin_api_proxy` に対して「API設定の雛形（プリセット）」を登録できる仕組みを作ります。
特に、外部APIを呼ばずにプログラム内部でデータを生成・返却する場合も考慮します。

### 2.2 処理フックとユースケース
差し込みデータにフックを定義して、`plugin_api_proxy` の標準処理の代わりに、プリセット側の処理を呼び出せるようにします。

**主なユースケース:**
*   **パフォーマンス向上**: 当初は外部APIで都道府県リストを取得していたが、レスポンス高速化のためNocoBaseサーバ上のメモリ内処理に切り替える。
*   **ロジック実装**: 「続柄検索」など、外部APIではなくプログラムロジックでレスポンスを生成する。

**フックポイント:**
1.  **リクエスト時のマッピング**: リクエストパラメータの変換処理。
2.  **APIコールの代わりの処理 (Exection Hook)**: 実際にデータを取得・生成する処理。外部APIコールの代わりに実行されます。
3.  **レスポンスのマッピング**: 取得したデータの変換処理。
    *   例: レスポンスのマッピングだけをプログラムで処理したい場合など。

### 2.3 登録インターフェース案
```typescript
interface ApiPreset {
  key: string;
  label: string;
  // 外部API設定のデフォルト値
  url?: string;
  headers?: any;
  // プログラム処理用フック (Optional)
  onRequest?: (context: Context) => Promise<any>; // マッピング前/後の制御
  execute?: (requestData: any) => Promise<any>;   // APIコールの代わりの処理
  onResponse?: (responseData: any) => Promise<any>; // レスポンスマッピング処理
}

## 4. APIテスト機能

### 4.1 概要
設定画面上で、定義したマッピングルールが意図通りに機能するかを確認するためのテスト実行機能を提供します。

### 4.2 機能要件
- **パラメータ入力**: `testParams` にテスト値を保存可能にします。
- **実行と検証**:
    - **実行ボタン**: 設定されたマッピングとテスト値を用いて実行します。
    - **期待値との比較**: `expectedResponse` と実行結果を比較し、検証を容易にします。
- **結果表示**: 変換前の生レスポンス、変換後のマッピング済みデータ、およびステータスを表示します。

```

## 3. 今後の進め方
1.  **PresetManagerの実装**: フック機能を含むプリセット管理クラスの実装。
2.  **データ構造の実装**: `api_proxy_apis` コレクションへのフィールド追加。
3.  **Processorの実装**: 上記「1.3 レスポンスデータの処理の流れ」を実装するプロセッサロジックの作成。
4.  **UI実装**: 設定画面への反映（別タスクにてUI設計詳細化）。

以上
